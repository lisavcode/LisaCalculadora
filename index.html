<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lisa Calculadora</title>
    <meta name="description" content="Calculadora de Lisa" />
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ["Outfit", "sans-serif"] },
            colors: {
              primary: "rgb(var(--color-primary-rgb) / <alpha-value>)",
              bg: "var(--color-bg)",
            },
          },
        },
      };
    </script>
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <style>
      body {
        margin: 0;
        overflow: hidden;
        background-color: var(--color-bg, #000);
        color: var(--color-text, white);
        font-family: "Outfit", sans-serif;
      }

      .app-view {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        border: none;
        opacity: 0;
        pointer-events: none;
        z-index: 10;
        transition:
          transform 0.6s cubic-bezier(0.7, 0, 0.3, 1),
          opacity 0.4s ease;
      }
      .app-view.active {
        opacity: 1;
        pointer-events: auto;
        transform: scale(1);
      }

      /* Black Hole / TV Animation Classes */
      .app-view.imploding {
        opacity: 0.8;
        transform: scale(0.01) scaleY(0.02);
        transition:
          transform 0.5s cubic-bezier(0.7, 0, 0.8, 0.2),
          opacity 0.5s ease;
      }

      /* TV Line Effect */
      .tv-line {
        position: fixed;
        top: 50%;
        left: 0;
        width: 100%;
        height: 2px;
        background: #fff;
        transform: scaleX(0);
        opacity: 0;
        pointer-events: none;
      }
      .tv-line.active {
        animation: tv-flash 0.1s ease-out forwards;
      }

      @keyframes tv-flash {
        0% {
          transform: scaleX(0);
          opacity: 0;
        }
        40% {
          transform: scaleX(1);
        }
        70% {
          transform: scaleX(1.1) scaleY(2);
        }
        100% {
          transform: scaleX(0);
          opacity: 0;
        }
      }

      /* Minimalist Navbar */
      .navbar {
        position: fixed;
        bottom: 2rem;
        left: 50%;
        transform: translateX(-50%);
        background: rgb(
          var(--color-surface-rgb) / 0.85
        ); /* Aumentado a opacidade já que o blur saiu */
        border: 1px solid rgb(var(--color-primary-rgb) / 0.1);
        border-radius: 20px;
        padding: 6px;
        display: flex;
        gap: 4px;
        z-index: 50; /* Baixado para permitir que modais fiquem por cima se necessário */
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      }
      .navbar.hidden-ui {
        opacity: 0;
        pointer-events: none;
        transform: translateX(-50%) translateY(100px);
      }
      .navbar:hover {
        background: rgb(var(--color-surface-rgb) / 0.8);
        border-color: rgb(var(--color-primary-rgb) / 0.3);
      }

      .nav-item {
        color: var(--color-text-muted, rgba(255, 255, 255, 0.4));
        padding: 10px 20px;
        border-radius: 14px;
        font-weight: 500;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        cursor: pointer;
        transition: all 0.3s ease;
      }
      .nav-item:hover {
        color: var(--color-text);
        background: rgb(var(--color-primary-rgb) / 0.05);
      }
      .nav-item.active {
        color: var(--color-primary);
        background: rgb(var(--color-primary-rgb) / 0.15);
      }
    </style>
  </head>
  <body>
    <iframe id="view-inicio" src="inicio.html" class="app-view active"></iframe>
    <iframe
      id="view-calculadora"
      src="calculadora/index.html"
      class="app-view"
    ></iframe>
    <iframe
      id="view-encomendas"
      src="encomendas/index.html"
      class="app-view"
    ></iframe>

    <div id="tv-line" class="tv-line"></div>

    <nav class="navbar" id="main-navbar">
      <button
        class="nav-item active"
        data-target="inicio"
        onclick="switchView('inicio')"
      >
        Início
      </button>
      <button
        class="nav-item"
        data-target="calculadora"
        onclick="switchView('calculadora')"
      >
        Calculadora
      </button>
      <button
        class="nav-item"
        data-target="encomendas"
        onclick="switchView('encomendas')"
      >
        Encomendas
      </button>
    </nav>

    <script>
      let isAnimating = false;

      // --- Controle de Visibilidade UI ---
      function setUIVisibility(visible) {
        const navbar = document.getElementById("main-navbar");
        if (visible) {
          navbar.classList.remove("hidden-ui");
        } else {
          navbar.classList.add("hidden-ui");
        }
      }

      // Escuta eventos globais para ocultar o menu do Hub
      window.addEventListener("hide-hub-ui", () => setUIVisibility(false));
      window.addEventListener("show-hub-ui", () => setUIVisibility(true));

      // --- Sincronização de Cores ---
      function applyThemeColors() {
        const savedTheme = localStorage.getItem("app_theme") || "dark";
        const savedConfigs = localStorage.getItem("app_themes_config");

        if (savedConfigs) {
          try {
            const themes = JSON.parse(savedConfigs);
            const theme = themes[savedTheme];
            if (theme) {
              const root = document.documentElement;
              // Aplicar variáveis principais
              for (const [key, value] of Object.entries(theme)) {
                if (key.startsWith("--color-")) {
                  root.style.setProperty(key, value);
                  // Também gera a versão RGB para transparências do Tailwind/CSS
                  if (value.startsWith("#")) {
                    const r = parseInt(value.slice(1, 3), 16);
                    const g = parseInt(value.slice(3, 5), 16);
                    const b = parseInt(value.slice(5, 7), 16);
                    root.style.setProperty(`${key}-rgb`, `${r} ${g} ${b}`);
                  }
                }
              }

              // --- BROADCAST PARA FILHOS ---
              // Notifica todos os iframes para que eles também se atualizem
              document.querySelectorAll("iframe").forEach((iframe) => {
                try {
                  if (iframe.contentWindow) {
                    iframe.contentWindow.dispatchEvent(
                      new CustomEvent("app_settings_updated"),
                    );
                  }
                } catch (e) {
                  /* Silencia erros de cross-origin se houver */
                }
              });
            }
          } catch (e) {
            console.error("Erro ao carregar cores do Hub:", e);
          }
        }
      }

      // Inicializa cores
      applyThemeColors();

      // Escuta mudanças vindas dos Iframes ou outras janelas
      window.addEventListener("app_settings_updated", (e) => {
        applyThemeColors();
      });
      window.addEventListener("storage", (e) => {
        if (e.key === "app_themes_config" || e.key === "app_theme")
          applyThemeColors();
      });

      function switchView(targetId) {
        if (isAnimating) return;

        const currentActive = document.querySelector(".app-view.active");
        if (currentActive && currentActive.id === `view-${targetId}`) return;

        // Reset UI visibility on switch
        setUIVisibility(true);

        isAnimating = true;

        // Update UI
        document.querySelectorAll(".nav-item").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.target === targetId);
        });

        // Save last view preference
        localStorage.setItem("icarus_last_view", targetId);

        const tvLine = document.getElementById("tv-line");
        const nextView = document.getElementById(`view-${targetId}`);

        // Start Implosion
        currentActive.classList.add("imploding");

        setTimeout(() => {
          tvLine.classList.add("active");

          setTimeout(() => {
            currentActive.classList.remove("active", "imploding");
            nextView.classList.add("active");

            setTimeout(() => {
              tvLine.classList.remove("active");
              isAnimating = false;
            }, 300);
          }, 300);
        }, 300);
      }

      window.navigateTo = switchView;

      // Restore last view instantly on load
      (function restoreLastView() {
        const lastView = localStorage.getItem("icarus_last_view");
        if (lastView && lastView !== "inicio") {
          const targetView = document.getElementById(`view-${lastView}`);
          if (targetView) {
            // Remove active from any current
            document
              .querySelectorAll(".app-view")
              .forEach((el) => el.classList.remove("active"));
            targetView.classList.add("active");

            // Update nav buttons
            document.querySelectorAll(".nav-item").forEach((btn) => {
              btn.classList.toggle("active", btn.dataset.target === lastView);
            });
          }
        }
      })();
    </script>
  </body>
</html>
